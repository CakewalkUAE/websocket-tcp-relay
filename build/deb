#!/bin/bash
set -euo pipefail

trap "cd '$PWD'; rm -rf debroot debian-binary control.tar.gz data.tar.gz" EXIT

. /etc/lsb-release

pkg_version=${1:-$(git describe --tags | cut -c2- )}
pkg_revision=${2:-1}
architecture=${3:-$(dpkg --print-architecture)}

if [ "$architecture" != "$(dpkg --print-architecture)" ]
then
  shards install --production
  build/cross-compile-with-docker src/websocket-tcp-relay.cr "ubuntu:$DISTRIB_RELEASE"
else
  shards build --production --release --stats
fi

mkdir debroot
cd debroot

mkdir -p usr/bin usr/share/doc/websocket-tcp-relay lib/systemd/system/ etc
cp ../bin/* usr/bin/
cp ../README.md usr/share/doc/websocket-tcp-relay/README
cat > etc/websocket-tcp-relay.ini << EOF
[main]
upstream = tcp://127.0.0.1:5672
bind = 127.0.0.1
port = 15670
proxy-protocol = false
EOF

cat > usr/share/doc/websocket-tcp-relay/copyright << EOF
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: WebSocket TCP Relay
Upstream-Contact: support@cloudamqp.com
Source: https://github.com/cloudamqp/websocket-tcp-relay

Files: *
Copyright: 2021, 84codes AB
License: Apache-2.0
EOF
cat > lib/systemd/system/websocket-tcp-relay.service << 'EOF'
[Unit]
Description=WebSocket TCP Relay
Documentation=https://github.com/cloudamqp/websocket-tcp-relay
Requires=network.target
After=network.target

[Service]
ExecStart=/usr/bin/websocket-tcp-relay --config /etc/websocket-tcp-relay.ini
Restart=on-failure
User=www-data
Group=www-data
LimitNOFILE=1M
ProtectSystem=full

[Install]
WantedBy=multi-user.target
EOF

cat > etc/websocket-tcp-relay.ini << EOF
[main]
upstream = tcp://127.0.0.1:5672
bind = 0.0.0.0
port = 8080
tls-cert = /etc/ssl/certs/mycert.pem
tls-key = /etc/ssl/private/mykey.pem
proxy-protocol = false
webroot = /var/www/html
EOF

mkdir DEBIAN
find . -type f -not -path "./DEBIAN/*" -print0 | xargs -0 md5sum > DEBIAN/md5sums

cat > DEBIAN/control << EOF
Package: websocket-tcp-relay
Version: $pkg_version-$pkg_revision
Homepage: https://github.com/cloudamqp/websocket-tcp-relay
Section: net
Priority: optional
Architecture: $architecture
Depends: libc6, libssl1.1, libpcre3, zlib1g, libgcc1, $(dpkg -S libevent-2.1 | cut -d: -f1 | sort -u | paste -sd,)
Installed-Size: $(du -ks usr/ | cut -f 1)
Maintainer: CloudAMQP Team <contact@cloudamqp.com>
Description: WebSocket TCP Relay
 Allows any TCP server to be exposed as a WebSocket endpoint
EOF

cat > DEBIAN/conffiles << EOF
/etc/websocket-tcp-relay.ini
EOF

cat > DEBIAN/postinst << EOF
#!/bin/sh -e
deb-systemd-helper enable websocket-tcp-relay.service
deb-systemd-invoke start websocket-tcp-relay.service
EOF
chmod +x DEBIAN/postinst

cat > DEBIAN/prerm << EOF
#!/bin/sh -e
deb-systemd-invoke stop websocket-tcp-relay.service
deb-systemd-helper purge websocket-tcp-relay.service
EOF
chmod +x DEBIAN/prerm

cd ..

export GZIP=-9
tar czf data.tar.gz --exclude=./DEBIAN -C ./debroot ./
tar czf control.tar.gz -C ./debroot/DEBIAN ./
echo 2.0 > debian-binary

debdir=builds/debian/$DISTRIB_CODENAME
mkdir -p "$debdir"
debname=websocket-tcp-relay_$pkg_version-${pkg_revision}_$architecture.deb
ar r "$debdir/$debname" debian-binary control.tar.gz data.tar.gz
